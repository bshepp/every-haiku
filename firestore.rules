rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if true; // Public profiles
      allow create: if isOwner(userId) && 
        request.resource.data.keys().hasAll(['displayName', 'createdAt']);
      allow update: if isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['username']) || 
         !exists(/databases/$(database)/documents/usernames/$(request.resource.data.username)));
      allow delete: if false; // Users cannot be deleted
    }
    
    // Username uniqueness collection
    match /usernames/{username} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        !exists(/databases/$(database)/documents/usernames/$(username));
      allow update: if false; // Usernames cannot be changed once set
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Haikus collection
    match /haikus/{haikuId} {
      // Anyone can read public haikus
      allow read: if resource.data.isPublic == true;
      
      // Authenticated users can read their own haikus
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Authenticated users can create haikus
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['content', 'theme', 'isAI', 'createdAt', 'isPublic', 'isSaved']);
      
      // Users can update their own haikus (for making public or saving)
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can delete their own haikus
      allow delete: if isOwner(resource.data.userId);
    }
    
    // User's saved haikus
    match /userHaikus/{userId}/saved/{haikuId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // User likes
    match /userLikes/{userId}/likes/{haikuId} {
      allow read: if true; // Public to show who liked
      allow create: if isOwner(userId);
      allow update: if false; // Likes cannot be updated
      allow delete: if isOwner(userId);
    }
    
    // Following relationships
    match /following/{userId}/users/{followedId} {
      allow read: if true; // Public to show following
      allow create: if isOwner(userId) && userId != followedId;
      allow update: if false;
      allow delete: if isOwner(userId);
    }
    
    // Followers relationships
    match /followers/{userId}/users/{followerId} {
      allow read: if true; // Public to show followers
      allow write: if false; // Managed by Cloud Functions
    }
    
    // Collections
    match /collections/{collectionId} {
      allow read: if resource.data.isPublic == true || 
        (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Collection haikus
    match /collectionHaikus/{collectionId}/haikus/{haikuId} {
      allow read: if get(/databases/$(database)/documents/collections/$(collectionId)).data.isPublic == true ||
        (isAuthenticated() && get(/databases/$(database)/documents/collections/$(collectionId)).data.userId == request.auth.uid);
      allow write: if isAuthenticated() && 
        get(/databases/$(database)/documents/collections/$(collectionId)).data.userId == request.auth.uid;
    }
  }
}